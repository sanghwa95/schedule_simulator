<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Schedule Simulator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: 40px auto;
      padding: 0 20px;
      background: #f7f9fc;
    }

    h1 {
      text-align: center;
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }

    label {
      font-size: 12px;
      color: #555;
    }

    input {
      width: 100%;
      padding: 6px;
      margin-top: 3px;
    }

    button {
      margin-top: 15px;
      padding: 10px;
      background: #0070f3;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }

    button:hover {
      background: #0059c9;
    }

    .result {
      margin-top: 30px;
    }

    .card {
      background: white;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.05);
    }

    .timeline {
      font-family: monospace;
      font-size: 13px;
      margin-top: 10px;
    }

    .loading {
      text-align: center;
      font-weight: bold;
      color: #0070f3;
    }

    .dial-wrap {
      margin-top: 10px;
      display: flex;
      align-items: flex-start;
      gap: 24px;
    }

    .dial-title { font-size: 12px; color: #555; margin: 6px 0 8px; }

    .dial {
        width: 240px;
        height: 240px;
        flex-shrink: 0;
    }

    /* ì˜¤ë¥¸ìª½ íŒ¨ë„: legend + timeline */
    .side-panel {
        width: 320px;        /* âœ… ì˜¤ë¥¸ìª½ì´ ë„ˆë¬´ í—ˆì „í•˜ì§€ ì•Šê²Œ ê³ ì •í­ */
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    /* ê°€ìš´ë°: legend ì˜ì—­ */
    .legend-panel{
        width: 220px;            /* legend ê³ ì •í­ */
        flex-shrink: 0;
    }

    .legend {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 6px 10px;
        font-size: 12px;
    }

    /* ì˜¤ë¥¸ìª½: timeline ì˜ì—­ (ë‚¨ëŠ” ê³µê°„ ì „ë¶€ ì°¨ì§€) */
    .timeline-panel{
        flex: 1;                 /* âœ… ë¹¨ê°„ ì²´í¬ ë¶€ë¶„ì„ ë‹¤ ë¨¹ìŒ */
        min-width: 260px;        /* ë„ˆë¬´ ì¢ì•„ì§€ì§€ ì•Šê²Œ */
    }

    .timeline-text {
        font-family: monospace;
        font-size: 12px;
        line-height: 1.45;
        background: #ffffff;
        border: 1px solid #eee;
        border-radius: 8px;
        padding: 10px;
        max-height: 220px;   /* âœ… ê¸¸ë©´ ìŠ¤í¬ë¡¤ */
        overflow: auto;
    }

    .legend-item { display: flex; align-items: center; gap: 6px; }
    .swatch { width: 10px; height: 10px; border-radius: 2px; display: inline-block; }

    .actions { display:flex; gap:10px; margin-top:12px; }
    .actions button { padding:10px 14px; background:#0070f3; color:#fff; border:none; cursor:pointer; font-weight:bold; border-radius:6px; }
    .actions button.secondary { background:#444; }
    .actions button:disabled { opacity:0.5; cursor:not-allowed; }

    .card.top1 {
        border: 2px solid #ffb300;
        box-shadow: 0 6px 16px rgba(0,0,0,0.10);
        background: #fffdf5;
    }

    .chartWrap { height: 280px; width: 100%; }
    .chartWrap canvas { width: 100% !important; height: 100% !important; display:block; }

  </style>
</head>
<body>

<h1>Schedule Simulator</h1>

<div class="controls">
  <div>
    <label>Iterations</label>
    <input id="iters" type="number" value="10000">
  </div>
  <div>
    <label>Seed</label>
    <input id="seed" type="number" value="1">
  </div>
  <div>
    <label>Top</label>
    <input id="top" type="number" value="3">
  </div>
  <div>
    <label>Overtime Rate (won/h)</label>
    <input id="ot_rate" type="number" value="30000">
  </div>
  <div>
    <label>Max OT Hours</label>
    <input id="ot_max" type="number" value="4">
  </div>
  <div>
    <label>Minimum Wake-up Hour</label>
    <input id="min_wake_hour" type="number" value="6" min="0" max="12">
  </div>
  <div>
    <label>Maximum Wake-up Hour</label>
    <input id="max_wake_hour" type="number" value="9" min="0" max="12">
  </div>
  <div>
    <label>Slot (min)</label>
    <input id="slot" type="number" value="30">
  </div>
</div>

<button onclick="runSimulation()">Run Simulation</button>

<div class="actions">
  <button id="btnBest" onclick="showBest()" disabled>Show Best (Top 5)</button>
  <button id="btnWorst" class="secondary" onclick="showWorst()" disabled>Show Worst (Top 5)</button>
</div>

<div class="card" id="statsBox">
  <h2>ğŸ“Š Statistics</h2>

  <div class="chartWrap">
    <canvas id="histChart"></canvas>
  </div>

  <div class="chartWrap" style="margin-top:20px;">
    <canvas id="scatterChart"></canvas>
  </div>
</div>


<div id="output" class="result"></div>

<script>

let lastBest = null;
let lastWorst = null;

let histChartRef = null;
let scatterChartRef = null;

async function runSimulation() {
  const output = document.getElementById("output");
  output.innerHTML = "<div class='loading'>Running simulation...</div>";

  // âœ… top=5ë¡œ ê³ ì • (ì›í•˜ë©´ input ê°’ ì¨ë„ ë¨)
  const payload = {
    iters: Number(document.getElementById("iters").value),
    seed: Number(document.getElementById("seed").value),
    top: 5,
    ot_rate: Number(document.getElementById("ot_rate").value),
    ot_max: Number(document.getElementById("ot_max").value),
    min_wake_hour: Number(document.getElementById("min_wake_hour").value),
    max_wake_hour: Number(document.getElementById("max_wake_hour").value),
    slot: Number(document.getElementById("slot").value),
  };

  try {
    const res = await fetch("/api/simulate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const text = await res.text();
    if (!res.ok) {
      output.innerHTML = `
        <div style="color:red; font-weight:bold;">Request failed (HTTP ${res.status})</div>
        <pre style="white-space:pre-wrap; background:#fff; padding:12px; border-radius:8px;">${text}</pre>
      `;
      return;
    }

    const data = JSON.parse(text);

    console.log("STATS:", data.stats);

    renderResults(data);
    requestAnimationFrame(() => {
        renderStatsCharts(data.stats);
    });

    // âœ… ê²°ê³¼ ì €ì¥ë§Œ í•´ë‘ê³  ë²„íŠ¼ìœ¼ë¡œ ì¶œë ¥
    lastBest = data.best || [];
    lastWorst = data.worst || [];

    // ë²„íŠ¼ í™œì„±í™”
    document.getElementById("btnBest").disabled = (lastBest.length === 0);
    document.getElementById("btnWorst").disabled = (lastWorst.length === 0);

    // ì•ˆë‚´ ë©”ì‹œì§€ë§Œ í‘œì‹œ
    output.innerHTML = `
      <div class="card">
        Simulation complete.<br>
        Click <b>Show Best (Top 5)</b> or <b>Show Worst (Top 5)</b>.
      </div>
    `;
  } catch (err) {
    output.innerHTML = `
      <div style="color:red; font-weight:bold;">Error occurred (network/runtime)</div>
      <pre style="white-space:pre-wrap; background:#fff; padding:12px; border-radius:8px;">${String(err)}</pre>
    `;
  }
}


function renderResults(data) {
  const output = document.getElementById("output");
  output.innerHTML = "";

  function renderSchedule(title, list) {
    const section = document.createElement("div");
    section.innerHTML = `<h2>${title}</h2>`;
    list.forEach(item => {
      const card = document.createElement("div");
      card.className = "card";

      card.innerHTML = `
        <strong>Score:</strong> ${item.score}<br>
        <strong>Wake:</strong> ${item.wake} (${item.sleep_h}h sleep)<br>
        <strong>Money:</strong> ${item.money_won.toLocaleString()} won<br>
        <strong>Value:</strong> ${item.value}<br>
        <strong>Fatigue:</strong> ${item.fatigue}<br>
        <strong>Penalty:</strong> ${item.penalty}<br>
        <div class="timeline">
            ${renderDialSVG(item.timeline)}
            ${renderLegend(item.timeline)}
        </div>
      `;
      section.appendChild(card);
    });
    output.appendChild(section);
  }

  renderSchedule("ğŸ† Best Schedules", data.best);
  renderSchedule("âš  Worst Schedules", data.worst);
}

function clamp01(x) { return Math.max(0, Math.min(1, x)); }

function polar(cx, cy, r, angleRad) {
  return { x: cx + r * Math.cos(angleRad), y: cy + r * Math.sin(angleRad) };
}

// startMin/endMin: [0, 1440], 00:00ì´ ìœ„(12ì‹œ ë°©í–¥), ì‹œê³„ë°©í–¥ ì§„í–‰
function arcPath(cx, cy, rOuter, rInner, startMin, endMin) {
  const day = 1440;

  // 00:00ì„ 12ì‹œ ë°©í–¥ìœ¼ë¡œ ë§ì¶”ê¸° ìœ„í•´ -90ë„(= -pi/2) ì˜¤í”„ì…‹
  const startA = (startMin / day) * 2 * Math.PI - Math.PI / 2;
  const endA   = (endMin   / day) * 2 * Math.PI - Math.PI / 2;

  // í° í˜¸ ì—¬ë¶€
  let delta = endA - startA;
  // endê°€ 0 ë„˜ì–´ê°€ëŠ” ê²½ìš°(ì˜ˆ: 23:00~00:00) ì´ë¯¸ endMin=1440ìœ¼ë¡œ ë“¤ì–´ì˜¤ë¯€ë¡œ ê´œì°®ìŒ
  const largeArc = delta > Math.PI ? 1 : 0;

  const p1 = polar(cx, cy, rOuter, startA);
  const p2 = polar(cx, cy, rOuter, endA);
  const p3 = polar(cx, cy, rInner, endA);
  const p4 = polar(cx, cy, rInner, startA);

  // outer arc (clockwise), inner arc (counterclockwise)
  return [
    `M ${p1.x.toFixed(3)} ${p1.y.toFixed(3)}`,
    `A ${rOuter} ${rOuter} 0 ${largeArc} 1 ${p2.x.toFixed(3)} ${p2.y.toFixed(3)}`,
    `L ${p3.x.toFixed(3)} ${p3.y.toFixed(3)}`,
    `A ${rInner} ${rInner} 0 ${largeArc} 0 ${p4.x.toFixed(3)} ${p4.y.toFixed(3)}`,
    "Z"
  ].join(" ");
}

// ë¼ë²¨ë³„ ìƒ‰ìƒ (ì›í•˜ë©´ ì¡°ì •)
function labelColor(label) {
  const map = {
    "sleep": "#6c7ae0",
    "work": "#333333",
    "overtime work": "#ff8a00",
    "breakfast": "#00a86b",
    "lunch": "#00a86b",
    "dinner": "#00a86b",
    "study": "#00bcd4",
    "hobby": "#9c27b0",
    "exercise": "#e91e63",
    "rest": "#607d8b",
  };
  return map[label] || "#999999";
}

function renderDialSVG(timeline) {
  // timeline: [{start_min, end_min, label, start, end}, ...]
  const size = 260;
  const cx = size / 2;
  const cy = size / 2;
  const rOuter = 120;
  const rInner = 78;

  // SVG ì¡°ê° ë§Œë“¤ê¸°
  const slices = timeline.map(seg => {
    const d = arcPath(cx, cy, rOuter, rInner, seg.start_min, seg.end_min);
    const color = labelColor(seg.label);
    const title = `${seg.start}â€“${seg.end} ${seg.label}`;
    return `<path d="${d}" fill="${color}"><title>${title}</title></path>`;
  }).join("");

  // ì‹œê° í‘œì‹œìš© ëˆˆê¸ˆ(ì„ íƒ)
  const ticks = [0, 6, 12, 18].map(h => {
    const a = (h / 24) * 2 * Math.PI - Math.PI / 2;
    const p1 = polar(cx, cy, rOuter + 2, a);
    const p2 = polar(cx, cy, rOuter + 14, a);
    return `<line x1="${p1.x}" y1="${p1.y}" x2="${p2.x}" y2="${p2.y}" stroke="#bbb" stroke-width="2"/>`;
  }).join("");

  const labels = [0, 6, 12, 18].map(h => {
    const a = (h / 24) * 2 * Math.PI - Math.PI / 2;
    const p = polar(cx, cy, rOuter + 28, a);
    const text = String(h).padStart(2, "0");
    return `<text x="${p.x}" y="${p.y}" text-anchor="middle" dominant-baseline="middle" font-size="12" fill="#666">${text}</text>`;
  }).join("");

  return `
    <svg class="dial" viewBox="0 0 ${size} ${size}" role="img" aria-label="Daily schedule dial">
      <circle cx="${cx}" cy="${cy}" r="${rOuter}" fill="#f3f5f8"></circle>
      ${slices}
      <circle cx="${cx}" cy="${cy}" r="${rInner}" fill="white"></circle>
      ${ticks}
      ${labels}
      <circle cx="${cx}" cy="${cy}" r="2" fill="#888"></circle>
    </svg>
  `;
}

function renderLegend(timeline) {
  // ë¼ë²¨ë³„ë¡œ ì¤‘ë³µ ì œê±°í•´ì„œ legend êµ¬ì„±
  const seen = new Set();
  const items = [];
  for (const seg of timeline) {
    if (seen.has(seg.label)) continue;
    seen.add(seg.label);
    items.push(
      `<div class="legend-item"><span class="swatch" style="background:${labelColor(seg.label)}"></span>${seg.label}</div>`
    );
  }
  return `<div class="legend">${items.join("")}</div>`;
}

function showBest() {
  if (!lastBest) return;
  renderScheduleList("ğŸ† Best Schedules (Top 5)", lastBest);
}

function showWorst() {
  if (!lastWorst) return;
  renderScheduleList("âš  Worst Schedules (Top 5)", lastWorst);
}

function renderScheduleList(title, list) {
  const output = document.getElementById("output");
  output.innerHTML = "";

  const header = document.createElement("h2");
  header.textContent = title;
  output.appendChild(header);

  list.forEach((item, idx) => {
    const card = document.createElement("div");
    card.className = "card" + (idx === 0 ? " top1" : "");

    // (ì›í˜• ê·¸ë˜í”„ë¥¼ ì´ë¯¸ ë„£ì–´ë‘” ìƒíƒœë¼ë©´ ì•„ë˜ dial ë¶€ë¶„ì€ ê·¸ ì½”ë“œ ìœ ì§€)
    card.innerHTML = `
      <strong>#${idx + 1}</strong><br>
      <strong>Score:</strong> ${item.score}<br>
      <strong>Wake:</strong> ${item.wake} (${item.sleep_h}h sleep)<br>
      <strong>Money:</strong> ${item.money_won.toLocaleString()} won<br>
      <strong>Value:</strong> ${item.value}<br>
      <strong>Fatigue:</strong> ${item.fatigue}<br>
      <strong>Penalty:</strong> ${item.penalty}<br>

      <div class="dial-wrap">
        ${renderDialSVG(item.timeline)}

        <div class="legend-panel">
          ${renderLegend(item.timeline)}
        </div>

        <div class="timeline-panel">
          ${renderTimelineText(item.timeline)}
        </div>
      </div>
    `;
    output.appendChild(card);
  });
}

function renderTimelineText(timeline) {
  const lines = timeline.map(t => `${t.start}â€“${t.end} ${t.label}`);
  return `<div class="timeline-text">${lines.join("<br>")}</div>`;
}

function renderStatsCharts(stats) {
  if (!stats) return;
  if (typeof Chart === "undefined") return;

  requestAnimationFrame(() => {
    const histCanvas = document.getElementById("histChart");
    const scatterCanvas = document.getElementById("scatterChart");

    if (!histCanvas || !scatterCanvas) return;

    // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
    if (histChartRef) {
      histChartRef.destroy();
      histChartRef = null;
    }
    if (scatterChartRef) {
      scatterChartRef.destroy();
      scatterChartRef = null;
    }

    // =========================
    // 1ï¸âƒ£ Score Histogram
    // =========================
    const h = stats.score_hist;
    const edges = h.edges || [];
    const counts = h.counts || [];

    const labels = counts.map((_, i) => {
      const a = edges[i];
      const b = edges[i + 1];
      return `${a.toFixed(1)}â€“${b.toFixed(1)}`;
    });

    histChartRef = new Chart(histCanvas.getContext("2d"), {
      type: "bar",
      data: {
        labels,
        datasets: [{
          label: "Score Count",
          data: counts
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,   // ğŸ”¥ ì¤‘ìš”
        plugins: {
          legend: { display: true }
        },
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });

    // =========================
    // 2ï¸âƒ£ Money vs Fatigue Scatter
    // =========================
    const pts = (stats.money_fatigue_scatter || []).map(p => ({
      x: p.money,
      y: p.fatigue
    }));

    scatterChartRef = new Chart(scatterCanvas.getContext("2d"), {
      type: "scatter",
      data: {
        datasets: [{
          label: "Money vs Fatigue",
          data: pts,
          pointRadius: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,   // ğŸ”¥ ì¤‘ìš”
        plugins: {
          legend: { display: true }
        },
        scales: {
          x: {
            title: {
              display: true,
              text: "Money (won)"
            }
          },
          y: {
            title: {
              display: true,
              text: "Fatigue"
            }
          }
        }
      }
    });

    // í˜¹ì‹œ ëª¨ë¥¼ ë ˆì´ì•„ì›ƒ ë¬¸ì œ ë°©ì§€
    histChartRef.resize();
    scatterChartRef.resize();
  });
}


</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</body>
</html>
